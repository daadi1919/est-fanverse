import express from "express";
import { ethers } from "ethers";
import { fanNFTAddress, fanNFTAbi } from "../../../client/src/utils/contract"; // ‚úÖ adapte si ton chemin est diff√©rent

const router = express.Router();

router.get("/:address", async (req, res) => {
  try {
    const address = req.params.address.toLowerCase();
    console.log("üîç Recherche des NFTs pour :", address);

    const provider = new ethers.JsonRpcProvider("http://localhost:8545"); // Hardhat local
    const contract = new ethers.Contract(fanNFTAddress, fanNFTAbi, provider);

    const uris: string[] = [];

    for (let i = 1; i <= 100; i++) {
      try {
        const owner = await contract.ownerOf(i);
        if (owner.toLowerCase() === address) {
          const uri = await contract.tokenURI(i);
          uris.push(uri);
        }
      } catch (err) {
        // D√®s que ownerOf √©choue, on suppose qu'on a d√©pass√© les NFTs mint√©s
        break;
      }
    }

    res.json({ nfts: uris });
  } catch (error) {
    console.error("‚ùå Erreur r√©cup√©ration NFTs :", error);
    res.status(500).json({ error: "Erreur r√©cup√©ration NFTs" });
  }
});

export default router;
